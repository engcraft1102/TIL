# 쿠키, 세션, 웹 스토리지

[TOC]

## HTTP의 특징과 쿠키, 세션, 웹 스토리지를 사용하는 이유

![img](cookie_session_web_storage.assets/img.png)

- 쿠키, 세션, 웹 스토리지 모두 HTTP 프로토콜의 특징이자 약점을 보완하기 위해서 사용합니다.
- HTTP 프로토콜 환경에서 서버는 클라이언트가 누구인지 확인해야 합니다. 그 이유로 HTTP 프로토콜의 `connectionless`, `stateless`라는 특성이 있습니다.

### connectionless 비연결성

클라이언트가 요청을 한 후, 응답을 받으면 그 연결을 끊어버리는 특징

HTTP는 클라이언트가 서버에 request를 보내면, 서버는 클라이언트에게 요청에 맞는 reponse를 보내고 접속을 끊는 특성이 있습니다.

헤더에 `keep-alive`라는 값을 줘서 `커넥션: 이미 연결되어 있는 TCP 연결`을 재사용하는데 HTTP 1.1에서는 이것이 기본값입니다. 즉, `Handshake` 과정이 생략됩니다.

이 비연결성은 http의 구현을 간단하게 해 주었지만, 반대로 개발자에게는 이전의 요청을 기억하는 기능 구현이라는 오버헤드가 생기는 것을 의미하기도 했습니다. html5에서 웹소켓 등으로 연결을 지속하는 방법이 생기기 전에는 연결 지속이 불가능해서 `쿠키와 세션` 등으로 직접 클라이언트와 서버를 매핑시켜 주어야 했습니다.

### stateless 무상태

- `connectionless`로 인해 서버는 클라이언트를 식별할 수가 없는데 이를 `stateless`라고 합니다.
- 연결이 끊어지는 순간 클라이언트와 서버의 통신이 끝나며 상태 정보가 휘발되는 특성입니다. 
  - 예를 들면, 음식 주문 하려고 하는데 페이지를 이동할 때마다 로그인을 해야 하는 것입니다.

## 쿠키

- 쿠키는 클라이언트에 저장되는 키와 값이 들어있는 작은 데이터 파일입니다.
- 사용자 인증이 유효한 시간을 명시할 수 있으며, 유효 시간이 정해지면 브라우저가 종료되어도 인증이 유지됩니다.
- 클라이언트에 300개까지 저장할 수 있으며, 하나의 도메인당 20개의 값만 가질 수 있고, 쿠키의 크기는 최대 4KB입니다.
- `Response Header`에 `Set-Cookie` 속성을 사용하면 클라이언트에 쿠키를 설정할 수 있습니다.
- 쿠키는 사용자가 따로 요청하지 않아도 브라우저가 `Request Header`를 넣어서 서버에 전송합니다.
  - `세션쿠키 (Session Cookie)` 활성 웹 브라우저 세션이 있는 기간동안 저장된다. 세션쿠키는 일반적으로 웹 브라우저를 닫을 때 삭제된다.
  - `영구쿠키/지속적쿠키 (Persistent Cookie)` 각 쿠키에 지정된 기간동안 또는 장치에서 쿠키를 수동으로 삭제할 때까지 장치에 남아있는다.

### 쿠키의 동작 방식

1. 클라이언트가 페이지를 요청
2. 서버에서 쿠키 생성
3. HTTP 헤더에 쿠키를 포함해 응답
4. 브라우저가 종료되어도 쿠키 만료 기간이 있다면 클라이언트에서 보관
5. 같은 요청을 할 경우 HTTP 헤더에 쿠키를 함께 전송
6. 서버에서 쿠키를 읽어 상태 정보를 변경할 필요가 있다면 쿠키를 업데이트하여 HTTP 헤더에 포함시킨 후 응답

### 쿠키의 사용 예시

- "아이디와 비밀번호를 저장하시겠습니까?"
- 장바구니
- 자동로그인, "오늘 더 이상 이 창을 보지 않음"

## 세션

- 사용자 정보 파일을 브라우저에 저장하는 쿠키와 달리 세션은 서버 측에서 관리합니다.
- 서버에서는 클라이언트를 구분하기 위해 세션 ID를 부여하며 웹 브라우저가 서버에 접속해서 브라우저를 종료할 때까지 인증상태를 유지합니다.
- 물론 접속 시간에 제한을 두어 일정 시간 응답이 없다면 정보가 유지되지 않게 설정이 가능 합니다.
- 사용자에 대한 정보를 서버에 두기 때문에 쿠키보다 보안에 좋지만, 사용자가 많아질수록 서버 메모리를 많이 차지하게 됩니다.
- 즉 동접자 수가 많은 웹 사이트인 경우 서버에 과부하를 주게 되므로 성능 저하의 요인이 됩니다.
- 클라이언트가 Request를 보내면, 해당 서버의 엔진이 클라이언트에게 유일한 ID를 부여하는 데 이것이 세션ID입니다.

### 세션의 동작 방식

- 클라이언트가 서버에 접속 시 세션 ID를 발급받습니다.
- 클라이언트는 세션 ID에 대해 쿠키를 사용해서 저장하고 가지고 있습니다.
- 클라이언트는 서버에 요청할 때, 이 쿠키의 세션 ID를 서버에 전달해서 사용합니다.
- 서버는 세션 ID를 전달 받아서 별다른 작업없이 세션 ID로 세션에 있는 정보를 가져옵니다.

### 세션의 사용 예

- 로그인처럼 보안 상 중요한 작업을 수행할 때 사용

## 웹 스토리지

- 웹 스토리지란 HTML5부터 제공하는 기능으로, **해당 도메인과 관련된 특정 데이터**를 서버가 아니라 **클라이언트의 웹브라우저에 저장**할 수 있는 기능입니다. 쿠키와 비슷합니다.
- Web Storage의 개념은 키-값 쌍으로 데이터를 저장하고, 키를 기반으로 데이터를 조회하는 패턴입니다. Local Storage(영구저장소)와 SessionStorage(임시저장소)를 따로 두어 **데이터의 지속성을 구분할 수 있어** 응용 환경에 맞는 선택이 가능합니다.
- Web Storage는 쿠키와 마찬가지로 **사이트의 도메인 단위로 접근이 제한**됩니다.

### 로컬 스토리지와 쿠키의 차이점

- 쿠키는 매번 서버로 전송됩니다. 웹사이트에서 쿠키를 설정하면 이후 모든 웹 요청은 쿠키정보를 포함해 서버로 전송됩니다. **그러나 웹 스토리지는 저장된 데이터가 클라이언트에 존재할 뿐 서버로 전송되지는 않습니다. 그리고 이는 네트워크 트래픽 비용을 줄여줍니다.**
- 웹 스토리지는 단순 문자열을 넘어 객체 정보를 저장할 수 있습니다. 문자열 기반 데이터 외에 **체계적으로 구조화된 객체를 저장할 수 있습니다.** (단, 브라우저의 지원 여부를 확인해봐야 합니다.)
- 웹 스토리지는 용량의 제한이 없습니다.

### 로컬 스토리지, 세션 스토리지의 차이

LocalStorage : 브라우저를 닫았다가 다시 열어도 계속 유지됩니다.

- 다만 동일한 컴퓨터에서 동일한 브라우저를 사용할 때만 해당됩니다.

SessionStorage: 브라우저를 닫으면 삭제됩니다.

- 도메인별로 별도로 생성되며, 같은 사이트의 다른 도메인이라도 브라우저가 다르면 서로 다른 영역이 됩니다. Browser Context가 다르기 때문입니다.

## 요약

브라우저 저장소로 Cookie와 Web Storage가 있습니다. 둘 모두 해당 도메인과 관련된 데이터를 클라이언트 웹 브라우저에 저장할 수 있도록 해줍니다. 둘 다 사이트의 도메인 단위로 접근이 제한됩니다. 예를 들면, A 도메인에서 저장한 데이터는 B 도메인에서 접근할 수 없는 것입니다.

Cookie는 매번 서버로 전송되고, 문자열만 저장이 가능하며, 용량 제한, 만료 일자가 존재합니다.

Web Storage는 데이터를 서버에 전송하지 않습니다. 문자열 외에도 구조화된 객체를 저장할 수 있어 개발 편의성을 제공해 주고, 용량도 무제한입니다. 영구성도 띕니다.

웹 스토리지와 쿠키 모두 해당 도메인과 관련된 특정 데이터를 서버가 아니라 클라이언트의 웹브라우저에 저장할 수 있습니다. 다만 웹 스토리지는 쿠키와 다르게 데이터를 저장할 뿐, 서버로 전송하지는 않습니다. 그래서 네트워크 트래픽 비용을 줄여줍니다. 그리고 용량의 제한이 없으며, 만료일자가 존재하지 않아 영구 보관이 가능합니다. 로컬스토리지와 세션스토리지는 데이터의 지속성이 달라, 선택적으로 사용할 수 있습니다. 또한 웹스토리지 역시 그냥 js 객체이기 때문에 js 객체를 넣는 것이 가능하며 문자열 + 크기제한 콤보를 가진 cookie에 비해서 비교우위를 가집니다.

## 정리

|                              |                            cookie                            | localStorage | sessionStorage |
| :--------------------------: | :----------------------------------------------------------: | :----------: | :------------: |
|            생성자            | 클라이언트나 서버. 서버는 `Set-Cookie` 헤더를 사용할 수 있다. |  클라이언트  |   클라이언트   |
|             만료             |                        수동으로 설정                         |    영구적    |  탭을 닫을 때  |
|      브라우저 세션 지속      |                  만료 설정 여부에 따라 다름                  |      O       |       X        |
| HTTP 요청과 함께 서버로 보냄 |           쿠키는 `Cookie` 헤더를 통해 자동 전송됨            |      X       |       X        |
|       용량 (도메인당)        |                             4kb                              |     5MB      |      5MB       |
|            접근성            |                         모든 윈도우                          | 모든 윈도우  |    같은 탭     |

## References

- https://interconnection.tistory.com/74
- https://velog.io/@koeunyeon/HTTP-%EA%B8%B0%EC%B4%88-1-%EC%A0%95%EC%9D%98-%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C-%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EC%99%80-%EC%84%9C%EB%B2%84-%EB%B9%84%EC%97%B0%EA%B2%B0%EC%84%B1
